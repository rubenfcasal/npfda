<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to the npfda Package • npfda</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to the npfda Package">
<meta property="og:description" content="npfda">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">npfda</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/npfda.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rubenfcasal/npfda/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to the npfda Package</h1>
                        <h4 data-toc-skip class="author">Ruben
Fernandez-Casal (<a href="mailto:ruben.fcasal@udc.es" class="email">ruben.fcasal@udc.es</a>)</h4>
            
            <h4 data-toc-skip class="date">npfda 0.1.3</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/rubenfcasal/npfda/blob/HEAD/vignettes/npfda.Rmd" class="external-link"><code>vignettes/npfda.Rmd</code></a></small>
      <div class="hidden name"><code>npfda.Rmd</code></div>

    </div>

    
    
<p>This vignette (a working draft) tries to illustrate the use of the
<code>npfda</code> (Nonparametric functional data analysis) package.
This package implements nonparametric methods for inference on
functional processes, avoiding the misspecification problems that may
arise when using parametric models.</p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rubenfcasal/npfda" class="external-link">npfda</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: npsp</span></span></code></pre>
<pre><code><span><span class="co">##  Package npsp: Nonparametric Spatial Statistics,</span></span>
<span><span class="co">##  version 0.7-12 (built on 2023-05-05).</span></span>
<span><span class="co">##  Copyright (C) R. Fernandez-Casal 2012-2023.</span></span>
<span><span class="co">##  Type `help(npsp)` for an overview of the package or</span></span>
<span><span class="co">##  visit https://rubenfcasal.github.io/npsp.</span></span></code></pre>
<pre><code><span><span class="co">##  npfda: Nonparametric functional data analysis,</span></span>
<span><span class="co">##  version 0.1.3 (built on 2023-05-12).</span></span></code></pre>
<p>The <code>ozone</code> data set, supplied with the <code>npfda</code>
package, will be used in the examples in this document. The data consist
of daily averages of ozone concentration (microgram per cubic meter)
recorded over the period from 1988 to 2020 at the Yarner Wood AURN
monitoring site in the UK.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/npf.data.html">npf.data</a></span><span class="op">(</span><span class="va">ozone</span>, dimnames <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fd</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">fd</span><span class="op">$</span><span class="va">ynames</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="npfda_files/figure-html/unnamed-chunk-2-1.png" width="100%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fd</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">fd</span><span class="op">$</span><span class="va">ynames</span><span class="op">)</span>, </span>
<span>     col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">32</span>, palette <span class="op">=</span> <span class="st">"Blue-Red 3"</span>, alpha <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="npfda_files/figure-html/unnamed-chunk-2-2.png" width="100%" style="display: block; margin: auto;"></p>
<p>For example, continuing with the exploratory graphical analysis, we
can plot the functional mean of the sample and this mean plus and minus
one sample standard deviation as a reference of the variability of the
data:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fd</span>, col <span class="op">=</span> <span class="st">"lightgray"</span>, legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/npsp/man/coords.html" class="external-link">coords</a></span><span class="op">(</span><span class="va">fd</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/f.mean.html">f.mean</a></span><span class="op">(</span><span class="va">fd</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matlines</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="../reference/f.mean.html">f.var</a></span><span class="op">(</span><span class="va">fd</span>, mean <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/outer.html" class="external-link">%o%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">1</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="npfda_files/figure-html/unnamed-chunk-3-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="trend-estimation">Trend estimation<a class="anchor" aria-label="anchor" href="#trend-estimation"></a>
</h2>
<p>The linear Local trend estimates can be computed using the
<code><a href="https://rdrr.io/pkg/npsp/man/locpol.html" class="external-link">locpol()</a></code> generic function:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trend.h</span> <span class="op">&lt;-</span> <span class="fl">36</span></span>
<span><span class="va">lp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/npsp/man/locpol.html" class="external-link">locpol</a></span><span class="op">(</span><span class="va">fd</span>, h <span class="op">=</span> <span class="va">trend.h</span><span class="op">)</span></span>
<span><span class="co"># Plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fd</span>, col <span class="op">=</span> <span class="st">"lightgray"</span>, legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">lp</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">x</span>, <span class="va">lp</span><span class="op">$</span><span class="va">biny</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co"># x = coords(fd)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">lp</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">x</span>, <span class="va">lp</span><span class="op">$</span><span class="va">est</span><span class="op">)</span></span></code></pre></div>
<p><img src="npfda_files/figure-html/unnamed-chunk-4-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>The smoothing procedures in <code>npfda</code> (following
<code>npsp</code> package) use binning to aggregate the data. For
instance, instead of the previous code we can use:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bin</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/npf.binning.html">npf.binning</a></span><span class="op">(</span><span class="va">fd</span><span class="op">)</span> <span class="co"># binning</span></span>
<span><span class="va">lp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/npsp/man/locpol.html" class="external-link">locpol</a></span><span class="op">(</span><span class="va">bin</span>, h <span class="op">=</span> <span class="va">trend.h</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="bandwidth-selection">Bandwidth selection<a class="anchor" aria-label="anchor" href="#bandwidth-selection"></a>
</h2>
<p>The trend estimates depends crucially on the bandwidth matrix <span class="math inline">\(h\)</span>. A small bandwidth will produce
undersmoothed estimates, whereas a big bandwidth will oversmooth the
data. Although it may be subjectively choosed by eye, it could be very
beneficial to have automatic selection criteria from the data.</p>
<p>The bandwidth can be selected through the <code><a href="https://rdrr.io/pkg/npsp/man/h.cv.html" class="external-link">h.cv()</a></code>
function. Traditional bandwidth selectors, such as cross validation (CV)
or generalized cross validation (GCV), do not have a good performance
for dependent data (Opsomer et al, 2001), since they tend to undersmooth
the data. By default the modified cross-validation criteria (MCV; Chu
and Marron, 1991) is used, by ignoring observations in a neighborhood
<span class="math inline">\(N(j)\)</span> around <span class="math inline">\(t_j\)</span>. Note that the ordinary CV approach
is a particular case with <span class="math inline">\(N(j)=\left\lbrace
t_{j} \right\rbrace\)</span>.</p>
<p>For instance (implicitly assuming ):</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># bin &lt;- npf.binning(fd)</span></span>
<span><span class="va">trend.h.cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/npsp/man/h.cv.html" class="external-link">h.cv</a></span><span class="op">(</span><span class="va">bin</span><span class="op">)</span><span class="op">$</span><span class="va">h</span></span>
<span><span class="va">trend.h.cv</span></span></code></pre></div>
<pre><code><span><span class="co">##          [,1]</span></span>
<span><span class="co">## [1,] 4.947342</span></span></code></pre>
<p>Nevertheless, as independence and homoscedasticity was implicitly
assumed, the selected bandwidth seems to undersmooth the data:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Linear Local trend estimates</span></span>
<span><span class="va">lp.cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/npsp/man/locpol.html" class="external-link">locpol</a></span><span class="op">(</span><span class="va">bin</span>, h <span class="op">=</span> <span class="va">trend.h.cv</span><span class="op">)</span></span>
<span><span class="co"># Plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">lp.cv</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">data</span>, col <span class="op">=</span> <span class="st">"lightgray"</span>, legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">x</span>, <span class="va">biny</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">x</span>, <span class="va">est</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p><img src="npfda_files/figure-html/unnamed-chunk-7-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>An alternative is the corrected generalized cross-validation
criterion (CGCV) that takes the temporal dependence into account,
proposed in Francisco-Fernández and Opsomer (2005) for the spatial case.
Nevertheless, the modeling of the dependence structure is previously
required to use this approach in practice.
<!-- (by setting `objective = "GCV"` and `cov.bin` in `h.cv()`). --></p>
</div>
<div class="section level2">
<h2 id="variance-estimation">Variance estimation<a class="anchor" aria-label="anchor" href="#variance-estimation"></a>
</h2>
<p>The linear Local variance estimates can be computed using the
<code><a href="../reference/np.var.html">np.var()</a></code> generic function:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">var.h</span> <span class="op">&lt;-</span> <span class="fl">33</span></span>
<span><span class="va">lp.var</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/np.var.html">np.var</a></span><span class="op">(</span><span class="va">lp</span>, h <span class="op">=</span> <span class="va">var.h</span><span class="op">)</span></span>
<span><span class="co"># Plot data + estimated trend -+ estimated std. dev.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">lp</span><span class="op">$</span><span class="va">data</span>, col <span class="op">=</span> <span class="st">"lightgray"</span>, legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">lp</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">x</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">lp</span><span class="op">$</span><span class="va">est</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matlines</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">lp.var</span><span class="op">$</span><span class="va">est</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/outer.html" class="external-link">%o%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">1</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="npfda_files/figure-html/unnamed-chunk-8-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>The bandwidth can also be selected using the <code><a href="https://rdrr.io/pkg/npsp/man/h.cv.html" class="external-link">h.cv()</a></code>
function (assuming independence in this case):</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bin.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/npf.bin.res2.html">npf.bin.res2</a></span><span class="op">(</span><span class="va">lp</span><span class="op">)</span></span>
<span><span class="va">var.h.cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/npsp/man/h.cv.html" class="external-link">h.cv</a></span><span class="op">(</span><span class="va">bin.res2</span><span class="op">)</span><span class="op">$</span><span class="va">h</span></span>
<span><span class="co"># the selected bandwidth undersmoothes the squared residuals...</span></span>
<span><span class="va">var.h.cv</span></span></code></pre></div>
<pre><code><span><span class="co">##          [,1]</span></span>
<span><span class="co">## [1,] 6.941771</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Linear Local variance estimate</span></span>
<span><span class="va">lp.cv.var</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/np.var.html">np.var</a></span><span class="op">(</span><span class="va">lp</span>, h <span class="op">=</span> <span class="va">var.h.cv</span><span class="op">)</span></span>
<span><span class="co"># Plot data + estimated trend -+ estimated std. dev.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">lp</span><span class="op">$</span><span class="va">data</span>, col <span class="op">=</span> <span class="st">"lightgray"</span>, legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">lp</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">x</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">lp</span><span class="op">$</span><span class="va">est</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matlines</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">lp.cv.var</span><span class="op">$</span><span class="va">est</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/outer.html" class="external-link">%o%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">1</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="npfda_files/figure-html/unnamed-chunk-9-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="variogram-estimation">Variogram estimation<a class="anchor" aria-label="anchor" href="#variogram-estimation"></a>
</h2>
<p>Local linear variogram estimates can be computed with the
<code><a href="https://rdrr.io/pkg/npsp/man/np.svar.html" class="external-link">np.svar()</a></code> generic function, in this case from standardized
residuals. Function <code><a href="https://rdrr.io/pkg/npsp/man/h.cv.html" class="external-link">h.cv()</a></code> may be used to select the
corresponding bandwidth, minimizing the cross-validation relative
squared error of the semivariogram estimates by default (see
e.g. Fernández-Casal and Francisco-Fernández, 2014). Nevertheless, as
the default criterion does not take into account the dependence between
the sample semivariances, the resulting bandwidth should be increased to
avoid under-smoothing the variogram estimates.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bin.svar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/npsp/man/svar.bin.html" class="external-link">svar.bin</a></span><span class="op">(</span><span class="va">lp</span>, <span class="va">lp.var</span>, maxlag <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">h.svar</span> <span class="op">&lt;-</span> <span class="fl">1.5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/pkg/npsp/man/h.cv.html" class="external-link">h.cv</a></span><span class="op">(</span><span class="va">bin.svar</span><span class="op">)</span><span class="op">$</span><span class="va">h</span></span>
<span><span class="va">h.svar</span></span></code></pre></div>
<pre><code><span><span class="co">##          [,1]</span></span>
<span><span class="co">## [1,] 3.712871</span></span></code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svar.np</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/npsp/man/np.svar.html" class="external-link">np.svar</a></span><span class="op">(</span><span class="va">bin.svar</span>, h <span class="op">=</span> <span class="va">h.svar</span><span class="op">)</span></span>
<span><span class="co"># plot(svar.np)</span></span></code></pre></div>
<p>A valid variogram estimate is obtained by fitting a “nonparametric”
isotropic Shapiro-Botha variogram model (Shapiro and Botha, 1991), to
the nonparametric pilot estimates, by using function
<code><a href="https://rdrr.io/pkg/npsp/man/fitsvar.sb.iso.html" class="external-link">npsp::fitsvar.sb.iso()</a></code>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/npsp/man/fitsvar.sb.iso.html" class="external-link">fitsvar.sb.iso</a></span><span class="op">(</span><span class="va">svar.np</span>, dk <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">svm</span><span class="op">)</span></span></code></pre></div>
<p><img src="npfda_files/figure-html/unnamed-chunk-11-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="updating-the-estimates">Updating the estimates<a class="anchor" aria-label="anchor" href="#updating-the-estimates"></a>
</h2>
<p>The selection of optimal bandwidths for trend and variance
approximation, require estimation of the small-scale variability of the
process, leading to a circular problem. To avoid it, an iterative
algorithm could be used.<br>
Starting with initial bandwidths (e.g. obtained by any of the available
methods for independent data). At each iteration, the bandwidths are
selected using the variance and variogram estimates computed in the
previous iteration, and the model components are re-estimated. The
algorithm can be considered to converge when there are no large changes
in the selected bandwidths (which would be due to similar small-scale
variability estimates). In practice, just one iteration of this
algorithm is usually sufficient.</p>
<p>In this case, as the initial bandwidths were purposely set close to
their convergence values, a new selection of the bandwidth for the trend
estimation:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimated correlation matrix</span></span>
<span><span class="va">corr.est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/npsp/man/varcov.html" class="external-link">varcov</a></span><span class="op">(</span><span class="va">svm</span>, <span class="va">lp</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co"># Trend bandwidth selection (under heteroscedasticity and dependence)</span></span>
<span><span class="va">trend.h.new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/npsp/man/h.cv.html" class="external-link">h.cv</a></span><span class="op">(</span><span class="va">bin</span>, <span class="va">lp.var</span>, cor <span class="op">=</span> <span class="va">corr.est</span><span class="op">)</span><span class="op">$</span><span class="va">h</span></span>
<span><span class="va">trend.h.new</span></span></code></pre></div>
<pre><code><span><span class="co">##          [,1]</span></span>
<span><span class="co">## [1,] 36.37871</span></span></code></pre>
<p>results in a value almost the same as the initial one:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">error.h.trend</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">trend.h</span><span class="op">/</span><span class="va">trend.h.new</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">error.h.trend</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.01041033</span></span></code></pre>
<p>and the same happens for the variance estimation:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Variance bandwidth selection (under heteroscedasticity and dependence)</span></span>
<span><span class="va">var.h.new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/npsp/man/h.cv.html" class="external-link">h.cv</a></span><span class="op">(</span><span class="va">bin.res2</span>, <span class="va">lp.var</span>, cor <span class="op">=</span> <span class="va">corr.est</span><span class="op">)</span><span class="op">$</span><span class="va">h</span></span>
<span><span class="va">var.h.new</span></span></code></pre></div>
<pre><code><span><span class="co">##          [,1]</span></span>
<span><span class="co">## [1,] 33.85016</span></span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">error.var.h</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">var.h</span><span class="op">/</span><span class="va">var.h.new</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">error.var.h</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.02511527</span></span></code></pre>
<p>Therefore, it would not be necessary to iterate and we can consider
the previous estimates to be the definitive ones.</p>
</div>
<div class="section level2">
<h2 id="nonparametric-model">Nonparametric model<a class="anchor" aria-label="anchor" href="#nonparametric-model"></a>
</h2>
<p><strong><em>Work in progress…</em></strong></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">np.fit</span> <span class="op">&lt;-</span> <span class="fu">npf.model</span><span class="op">(</span><span class="va">lp</span>, <span class="va">lp.var</span>, <span class="va">svm</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Castillo-Páez, S., Fernández-Casal, R., García-Soidán, P. (2019). A
nonparametric bootstrap method for spatial data. <em>Comput. Stat. Data
An.</em>, <strong>137</strong>, 1–15.</p>
<p>Chu, C. K. and Marron, J. S. (1991). Comparison of Two Bandwidth
Selectors with Dependent Errors. <em>The Annals of Statistics</em>
<strong>19</strong>, 1906–1918.</p>
<p>Fan, J. and Gijbels, I. (1996). <em>Local polynomial modelling and
its applications</em>. Chapman &amp; Hall, London.</p>
<p>Fernández-Casal, R. (2023). npsp: Nonparametric Spatial Statistics. R
package version 0.7-12. <em><a href="https://github.com/rubenfcasal/npsp" class="external-link uri">https://github.com/rubenfcasal/npsp</a></em>.</p>
<p>Fernández-Casal R, Francisco-Fernández M (2014) Nonparametric
bias-corrected variogram estimation under non-constant trend, <em>Stoch.
Environ. Res. Ris. Assess.</em>, <strong>28</strong>, 1247-1259, <a href="https://doi.org/10.1007/s00477-013-0817-8" class="external-link">DOI</a>.</p>
<p>Francisco-Fernández, M. and Opsomer, J. D. (2005). Smoothing
parameter selection methods for nonparametric regression with spatially
correlated errors. <em>The Canadian Journal of Statistics</em>
<strong>33</strong>, 279–295.</p>
<p>Opsomer, J. D., Wang, Y. and Yang, Y. (2001). Nonparametric
regression with correlated errors. <em>Statistical Science</em>
<strong>16</strong>, 134–153.</p>
<p>Shapiro, A. and Botha, J.D. (1991). Variogram fitting with a general
class of conditionally non-negative definite functions.
<em>Computational Statistics and Data Analysis</em> <strong>11</strong>,
87–96.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Ruben Fernandez-Casal, Sergio Castillo-Paez, Miguel Flores.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
